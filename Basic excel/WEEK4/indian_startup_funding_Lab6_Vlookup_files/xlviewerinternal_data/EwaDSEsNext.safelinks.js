'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[64],{1451:function(u,D,a){a.r(D);var c=a(9);u=a(0);var b=a(4);D=a(222);var e=a(15),f=a(84);class d{constructor(M,S,W,O,T,Y){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=M;this.WebAffinitizedUrl=S;this.PolicyCookie=W;this.PolicyCookieTTL=O;this.WasServiceDown=T;this.AffinitizedUrl=Y}}Object(u.a)(d,
"SafeLinksData",null,[]);class h{constructor(M,S){this.JBc=M;this.stopwatch=S}}Object(u.a)(h,"SafeLinksGetUrlReputationRequestData",null,[]);var m=a(41),l=a(40);class v{constructor(M,S,W,O){this.mb=M;this.yh=S;this.xxg=W;v.Bh=O}jpa(M,S,W){try{var O=null;v.Bh&&(O=v.Bh.Ac("WebServiceCall","SafeLinksGetUrlReputation"));const T=new h(S,O);O={};O.AffinitizedUrl=M;O.TargetUrl=S;O.PolicyCookie=W;const Y=m.c(O);this.yh.Rm(this.xxg,2,Y,null,!1,2,Object(f.a)(this,this.sUi,"onGetUrlReputationSuccessCallback"),
Object(f.a)(this,this.rUi,"onGetUrlReputationFailureCallback"),T,void 0,void 0,3E3,3E3,"36");return!0}catch(T){e.ULS.sendTraceTag(588788033,378,10,T.message)}return!1}sUi(M){let S="OnGetUrlReputationSuccessCallback: ",W=10;const O=M.data.state;try{const T=m.b(M.data.te).reputationResults[0],Y=T.navigateUrl.length,va=O.JBc.length,ca=T.navigateUrl===O.JBc;T.navigateUrl&&0<T.navigateUrl.length&&(O.JBc=T.navigateUrl);S+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",
M.data.httpStatus,T.verdict,va.toString(),Y.toString(),ca.toString());W=50}catch(T){S+=String.format("Exception {0}",T.message)}this.x$e(O,S,W)}rUi(M){let S="OnGetUrlReputationFailureCallback: ";const W=M.data.state;try{S+=String.format("HttpStatus {0}",M.data.httpStatus)}catch(O){S+=String.format("Exception {0}",O.message)}this.x$e(W,S,10)}x$e(M,S,W){M.stopwatch&&(M.stopwatch.stop(),M.stopwatch=null);e.ULS.sendTraceTag(588788034,378,W,S);l.a.lf(M.JBc,void 0,"noopener,noreferrer","SafeLinksNav")}}
v.Bh=null;Object(u.a)(v,"SafeLinksNavigationHelper",null,[]);var t;(function(M){M[M.enabledByPolicy=0]="enabledByPolicy";M[M.disabledByPolicy=1]="disabledByPolicy";M[M.disabled_GetPolicyFailure=2]="disabled_GetPolicyFailure";M[M.disabled_PendingGetPolicyRequest=3]="disabled_PendingGetPolicyRequest"})(t||(t={}));Object(u.b)("SafeLinksNavigationState",t);var z=a(97),r=a(135),n=a(817),w=a(252),B=a(240),A=a(685),y=a(27),x=a(170),F=a(189);class I{constructor(M,S,W,O=!1,T=null,Y=null){this.AEa=this.zEa=
0;this.MAb=this.IUb=!1;this.Bra=null;this.xXa=!0;this.bYb=null;e.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.mb=M;this.yh=S;this.xSb=W;I.Bh=Y;this.yGg=O?this.mb.Xa("SafeLinksHandlerWebServiceBase"):this.mb.Xa("WebServiceBase");this.gGg=this.mb.Xa("SafeLinksHashedUserId");this.B5j=this.mb.Xa("SafeLinksWorkloadIdHeaderValue");this.bWb=this.mb.ud("SafeLinksMaxGetPolicyBootRetries",2);this.cWb=this.mb.ud("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.lVb=this.isSafeLinksEnabledForUser();
this.kVb=this.Uti();e.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.lVb,this.kVb);if(this.lVb&&this.kVb){S=(M=this.L4a())?M.IsSafeLinksEnabled.toLowerCase():"";W=this.hsd();e.ULS.sendTraceTag(36231312,378,50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",S,W);var va=!M||"unknown"===S||M.WasServiceDown||W,ca=r.a.hs();ca&&(ca.set("shouldGetSafeLinksDataFromServer",va.toString()),ca.set("isSafeLinksEnabledCacheValue",
S.toString()));this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksLicenseCheck",!1)&&T?(this.xXa=!1,T.execute(V=>{V.isFeatureEnabled("MsoUrlreputation",!0).then(ra=>{this.xXa=ra;ca.set("isUserLicensedForSafeLinks",this.xXa.toString());z.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",ca);this.xXa&&va&&this.Mdc(!0);return null})})):(z.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",0,"jpittsdirects",ca),va&&this.Mdc(!0))}}get appName(){return this.xSb}get sFc(){return this.yGg}get userId(){return this.gGg}get N0h(){const M=
this.sFc?this.sFc+"/":"",S=new w.QueryStringBuilder("SafeLinksHandler.ashx");S.Xi("app",this.appName);this.mb.qa("SafeLinksUseDebugHeader")&&S.Xi("action","debug");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&S.Xi("s2satpop","1");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&S.Xi("s2saat","1");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&S.Xi("s2se03","1");return String.format("{0}{1}&{2}",
M,S.toString(),b.AFrameworkApplication.Zi)}get F6h(){const M=this.sFc?this.sFc+"/":"",S=new w.QueryStringBuilder("SafeLinksHandler.ashx");S.Xi("app",this.appName);this.mb.qa("SafeLinksUseDebugHeader")&&S.Xi("action","debug");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&S.Xi("s2satpop","1");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&S.Xi("s2saat","1");this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",
!1)&&S.Xi("s2se03","1");S.Xi("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",M,S.toString(),b.AFrameworkApplication.Zi)}get tKi(){I.zSc||(I.zSc=new v(this.mb,this.yh,this.F6h,I.Bh));return I.zSc}jpa(M){if(!M)return e.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var S=this.kqi(M);e.ULS.sendTraceTag(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",
S,this.lVb,this.kVb,this.xXa);if(!(S&&this.lVb&&this.kVb&&this.xXa))return!1;S=0;const W=({state:S}=this.cHj()).returnValue;e.ULS.sendTraceTag(595079385,378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",t[S]);const O=r.a.hs();O&&O.set("SafeLinksNavigationState",t[S]);z.Health.instance.recordKpiUsage("SafeLinksNavigations",0,"jpittsdirects",O);if(!W)return 2!==S&&3!==S||z.Health.instance.recordKpiFailure("SafeLinksNavigations",t[S],!1,!0,null),!1;e.ULS.sendTraceTag(26019601,378,
50,"Using safelinks to navigate hyperlink");if(this.kHj())return this.hsd()?!1:this.tKi.jpa(this.XOh(),M,this.U5e());if(!this.hsd())return this.Tfg(M),!0;this.Bra=M;e.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");this.MAb=!1;this.Mdc();return!0}kqi(M){M=M.toLowerCase();const S=this.mb.Fw("SafeLinksUnsupportedProtocols");if(S)for(let W=0;W<S.length;W++)if(M.startsWith(S[W]))return!1;return!0}Mdc(M=!1){var S=r.a.hs();S&&S.set("isOnBootRequest",M.toString());z.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",
1,"jpittsdirects",S);z.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",0,"jpittsdirects",S);S=this.z5c("SafeLinksGetPolicy");this.yh.Rm(this.N0h,1,null,null,!0,2,Object(f.a)(this,this.h3h,"getSafeLinksDataFromServer_OnSuccessCallback"),Object(f.a)(this,this.g3h,"getSafeLinksDataFromServer_OnFailureCallback"),S,void 0,void 0,void 0,void 0,"23");this.MAb=M;this.IUb=!0;M?this.zEa++:this.AEa++}h3h(M){let S=B.a.rLi,W="";try{this.IUb=this.MAb=!1;var O=M.data.state;const Ba=({stopwatch:O}=
this.YAc(O)).returnValue,ka=Object.assign(new F.a,{durationMs:Ba});z.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",ka);e.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",M.data.httpStatus,M.data.te.length,Ba);if(M.data.httpStatus!==B.a.mP)W="Unexpected httpStatus: "+M.data.httpStatus.toString();else{O=null;try{O=m.b(M.data.te)}catch(Ka){W="Exception:"+Ka.toString()+" deserializing response";return}if(O){var T=
O.IsSafeLinksEnabled;if(void 0===T||null===T||0>=T.length)W="Invalid isSafeLinksEnabledString";else{e.ULS.sendTraceTag(594830613,378,50,"Retrieved isSafeLinksEnabledString {0}",T);var Y=I.cGd(T);if(void 0===O.WebAffinitizedUrl||null===O.WebAffinitizedUrl||0>=O.WebAffinitizedUrl.length)W="Invalid WebAffinitizedUrl";else if(void 0===O.PolicyCookie||null===O.PolicyCookie||0>=O.PolicyCookie.length)W="Invalid PolicyCookie";else if(void 0===O.PolicyCookieTTL||null===O.PolicyCookieTTL)W="Invalid PolicyCookieTTL";
else{var va=O.WebAffinitizedUrl,ca=O.PolicyCookie,V=O.AffinitizedUrl,ra=new Date;ra.setMinutes(ra.getMinutes()+(5<O.PolicyCookieTTL?O.PolicyCookieTTL-5:0));var N=ra.getTime(),ea=new d(T,va,ca,N,!1,V);this.V2f(ea);S=M.data.httpStatus;this.Bra&&(Y?(this.Tfg(this.Bra),this.AEa=this.zEa=0):(e.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),z.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",!0,!0,null),l.a.bV(this.Bra)),this.Bra=
null)}}}else W="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(Ba){W="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+Ba.toString()}finally{S!==B.a.mP&&this.w$e(S,W)}}g3h(M){this.IUb=!1;let S=500,W="";try{let O=M.data.state;const T=({stopwatch:O}=this.YAc(O)).returnValue,Y=Object.assign(new F.a,{durationMs:T});S=M.data.httpStatus;z.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest","HttpStatusCode_"+S.toString(),!1,!0,Y);W="Request Failed, Status="+
A.a[M.data.status]+" Duration: "+T}catch(O){W="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+O.toString()}finally{this.w$e(S,W)}}w$e(M,S=""){try{if(e.ULS.sendTraceTag(594830612,378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",M,S),this.zEa<this.bWb&&this.AEa<this.cWb)this.Mdc(this.MAb);else{this.MAb=!1;e.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.zEa,this.AEa,
M,S);S=null;const W=r.a.hs();W&&(W.set("HttpStatus",M.toString()),S=Object.assign(new F.a,{extendedProperties:W}));z.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",!1,!0,S);const O=new d("false","","",0,!0,"");this.V2f(O);this.Bra&&(e.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}","disabled_GetPolicyFailure"),z.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),l.a.bV(this.Bra),
this.Bra=null)}}catch(W){e.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",W.toString())}}Tfg(M){const S=this.U5e(),W=this.r7h(),O={};O.Url=M;O.SafeLinksCookie=S;O.CorrelationId=x.a.create().toString();O.WorkloadId=this.B5j;O.UserAgentInfo=y.a.GHa+"|"+this.appName;e.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",O.CorrelationId);l.a.vsc(l.a.FX(4),W,O)}isSafeLinksEnabledForUser(){const M=this.mb.Xa("IsSafeLinksEnabledForUser");return M?
I.cGd(M):!1}Uti(){const M=this.mb.Fw("SafeLinksDisabledBrowsers");if(y.a.Iz){if(this.mb.$p("SafeLinksForTeamsIsEnabled")&&this.mb.qa("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(M,"Electron"))return!1}else if(Array.contains(M,y.a.GHa))return!1;return"officecomhwa"===(this.mb.Xa(b.AFrameworkApplication.x8)||"").toLowerCase()?!1:!0}kHj(){return-1!==window.location.href.indexOf("&wd_slnh=1")||this.mb.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksUseNavigationHelperForMobile",
!1)&&y.a.z5?!0:y.a.Iz}cHj(){let M;M=0;const S=this.L4a(),W=S?S.IsSafeLinksEnabled:"";if(""!==W)return S.WasServiceDown?(e.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),{returnValue:!1,state:2}):"false"===W.toLowerCase()?(e.ULS.sendTraceTag(51664E3,378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:I.cGd(W),state:M};if(this.IUb)return M=3,e.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:M};if(this.zEa>=
this.bWb||this.AEa>=this.cWb)return M=2,e.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",this.zEa,this.bWb,this.AEa,this.cWb),{returnValue:!1,state:M};e.ULS.sendTraceTag(23900182,378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.bWb+this.cWb-(this.zEa+this.AEa));return{returnValue:!0,state:M}}U5e(){const M=
this.L4a();return M?M.PolicyCookie:""}r7h(){const M=this.L4a();return M?M.WebAffinitizedUrl:""}XOh(){const M=this.L4a();return M?M.AffinitizedUrl:""}pVh(){const M=new Date;try{const S=this.L4a();M.setTime(S?S.PolicyCookieTTL:0)}catch(S){e.ULS.sendTraceTag(24462658,378,10,"Exception occured while fetching expiration time from cache: {0}",S)}return M}hsd(){const M=this.pVh();return!!M&&M.getTime()<Date.now()}L4a(){if(!this.bYb){const M=n.a.instance.getItem(this.userId);if(!M||""===M)return null;this.bYb=
JSON.parse(M)}return this.bYb}V2f(M){if(void 0===M||null===M)throw Error.argumentNull("safeLinksData");if(void 0===M.IsSafeLinksEnabled||null===M.IsSafeLinksEnabled||0>=M.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.bYb=M;M.WasServiceDown||this.K5j(M)}K5j(M){M=JSON.stringify(M);n.a.instance.setItem(this.userId,M)}z5c(M){return void 0!==I.Bh&&null!==I.Bh?I.Bh.Ac("WebServiceCall",M):null}YAc(M){if(void 0!==M&&null!==M){const S=M.zc;M.stop();return{returnValue:S,
stopwatch:null}}return{returnValue:null,stopwatch:M}}static cGd(M){return"false"!==M.toLowerCase()?!0:!1}}I.Bh=null;I.zSc=null;Object(u.a)(I,"SafeLinksManager",null,[381]);const L=M=>{switch(M){case 3:return"Word";case 2:return"PowerPoint";case 1:return"Excel";default:return"Unknown"}},X=M=>{switch(M){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}};var P=a(695);class G extends D.a{constructor(M){super();this.$=M;this.Fb()}create(){const M=Object(P.a)(this.$.da,
269,()=>new I(b.AFrameworkApplication.fa,b.AFrameworkApplication.Bd,`${L(b.AFrameworkApplication.sa.Pa.Fj)}-${X(b.AFrameworkApplication.sa.Pa.H6)}`));this.ob(M)}static ka(M){M.da.Ga(270,new G(M))}}Object(u.a)(G,"SafeLinksManagerFactory",D.a,[]);var C=a(1),H=a(229),J=a(217);Type.registerNamespace("_Ewa");Type.registerNamespace("Common.App.SafeLinks");(()=>{C.EwaSettings.Nrd()?Object(J.b)(H.c,{AOa:"singleton"})(()=>new I(b.AFrameworkApplication.fa,b.AFrameworkApplication.Bd,String.format("{0}-{1}",
L(b.AFrameworkApplication.sa.Pa.Fj),X(b.AFrameworkApplication.sa.Pa.H6)))):c.a.Fa(M=>{G.ka(M)})})()}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDSEsNext.safelinks.js.map/7da6545872bed32b7fecafd3f7d188de/EwaDSEsNext.safelinks.js.map